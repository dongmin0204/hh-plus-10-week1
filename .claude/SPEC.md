# κ°λ° μ¤ν™ (SPEC.md)

## π“‹ Step2 κΈ°λ¥ μ”κµ¬μ‚¬ν•­

### κΈ°λ³Έ κµ¬ν„ κΈ°λ¥ (Step1 μ™„λ£)
1. **ν¬μΈνΈ μ΅°ν** - νΉμ • μ μ €μ ν¬μΈνΈ ν™•μΈ β…
2. **ν¬μΈνΈ μ¶©μ „** - μ μ € ν¬μΈνΈ μ¦κ°€ + νμ¤ν† λ¦¬ κΈ°λ΅ β… 
3. **ν¬μΈνΈ μ‚¬μ©** - μ μ € ν¬μΈνΈ μ°¨κ° + νμ¤ν† λ¦¬ κΈ°λ΅ β…
4. **ν¬μΈνΈ λ‚΄μ—­** - μ μ €μ μ¶©μ „/μ‚¬μ© νμ¤ν† λ¦¬ μ΅°ν β…

### Step2 μ¶”κ°€ μ”κµ¬μ‚¬ν•­
1. **ν¬μΈνΈ μ •μ±… μ¶”κ°€**
   - μ”κ³  λ¶€μ΅± μƒμ„Έ κ²€μ¦ κ°•ν™”
   - μµλ€ μ”κ³  μ ν• (μ: 1,000,000 ν¬μΈνΈ)
   - μµμ† μ¶©μ „/μ‚¬μ© κΈμ•΅ μ •μ±…
   - μΌν μµλ€ μ¶©μ „/μ‚¬μ© κΈμ•΅ μ ν•

2. **λ™μ‹μ„± μ μ–΄**
   - λ™μΌν• μ‚¬μ©μμ λ™μ‹ μ”μ²­ μ •μƒ μ²λ¦¬
   - Race Condition λ°©μ§€
   - λ°μ΄ν„° μΌκ΄€μ„± λ³΄μ¥

3. **ν†µν•© ν…μ¤νΈ μ‘μ„±**
   - 4κ°€μ§€ κΈ°λ¥λ³„ ν†µν•© ν…μ¤νΈ
   - μ •μ±… κ΄€λ ¨ μμ™Έ μΌ€μ΄μ¤ κ²€μ¦
   - λ™μ‹μ„± μ΄μ μ μ–΄ λ° κ²€μ¦

## π”¨ κΈ°μ  μ¤ν™

### κΈ°μ  μ¤νƒ
- **Framework**: NestJS
- **Language**: TypeScript
- **Testing**: Jest (λ‹¨μ„ ν…μ¤νΈ + ν†µν•© ν…μ¤νΈ)
- **Architecture**: Layered (Controller β†’ Service β†’ Database)
- **Concurrency**: λ™μ‹μ„± μ μ–΄ λ©”μ»¤λ‹μ¦

### μ μ•½μ‚¬ν•­
- `UserPointTable`, `PointHistoryTable` ν΄λμ¤ **μ λ€ μμ • κΈμ§€**
- κ³µκ° APIλ§ μ‚¬μ©: `selectById`, `insertOrUpdate`, `insert`, `selectAllByUserId`
- λ‹¨μ„ ν…μ¤νΈ 100% μ»¤λ²„λ¦¬μ§€ μ μ§€
- ν†µν•© ν…μ¤νΈ μ¶”κ°€ μ‘μ„± ν•„μ

### Step2 μ¶”κ°€ μ •μ±…
- **μµλ€ μ”κ³ **: 1,000,000 ν¬μΈνΈ
- **μµμ† κ±°λ κΈμ•΅**: 1 ν¬μΈνΈ
- **μµλ€ μΌν μ¶©μ „**: 100,000 ν¬μΈνΈ
- **μµλ€ μΌν μ‚¬μ©**: 50,000 ν¬μΈνΈ

## π API μ¤ν™

### 1. ν¬μΈνΈ μ΅°ν
```http
GET /point/:id
Response: { id: number, point: number, updateMillis: number }
```

### 2. ν¬μΈνΈ μ¶©μ „
```http
PATCH /point/:id/charge
Body: { amount: number }
Response: { id: number, point: number, updateMillis: number }
Validation: amount > 0
```

### 3. ν¬μΈνΈ μ‚¬μ©
```http
PATCH /point/:id/use  
Body: { amount: number }
Response: { id: number, point: number, updateMillis: number }
Validation: amount > 0, currentPoint >= amount
```

### 4. ν¬μΈνΈ λ‚΄μ—­
```http
GET /point/:id/histories
Response: PointHistory[]
PointHistory: { id, userId, type, amount, timeMillis }
```

## β… Step2 μ™„λ£ κΈ°μ¤€

### κµ¬ν„ μ™„λ£ μ²΄ν¬λ¦¬μ¤νΈ
#### κΈ°λ³Έ κΈ°λ¥ (Step1 μ™„λ£)
- [x] PointService 4κ°€μ§€ λ©”μ„λ“ κµ¬ν„
- [x] κ° λ©”μ„λ“λ³„ λ‹¨μ„ ν…μ¤νΈ μ‘μ„± (μ •μƒ/μμ™Έ μ‹λ‚λ¦¬μ¤)
- [x] Controllerμ—μ„ Service νΈμ¶ μ—°λ™
- [x] Moduleμ— Service provider λ“±λ΅

#### Step2 μ¶”κ°€ κµ¬ν„
- [ ] ν¬μΈνΈ μ •μ±… ν΄λμ¤ κµ¬ν„
- [ ] μ •μ±… κ²€μ¦ λ΅μ§ PointServiceμ— μ μ©
- [ ] λ™μ‹μ„± μ μ–΄ λ©”μ»¤λ‹μ¦ κµ¬ν„
- [ ] ν†µν•© ν…μ¤νΈ νμΌ μƒμ„± λ° ν…μ¤νΈ μ‘μ„±
- [ ] μ •μ±… μμ™Έ μΌ€μ΄μ¤ ν…μ¤νΈ μ‘μ„±
- [ ] λ™μ‹μ„± ν…μ¤νΈ μ‘μ„±
- [ ] μ „μ²΄ ν…μ¤νΈ ν†µκ³Ό (λ‹¨μ„ + ν†µν•©)
- [ ] λΉλ“ μ„±κ³µ (npm run build)

### λΉ„μ¦λ‹μ¤ λ΅μ§ κ²€μ¦
#### Step1 κ²€μ¦ (μ™„λ£)
- [x] μ¶©μ „/μ‚¬μ© μ‹ μμ/0 κΈμ•΅ κ²€μ¦
- [x] ν¬μΈνΈ μ‚¬μ© μ‹ μ”μ•΅ λ¶€μ΅± κ²€μ¦  
- [x] λ¨λ“  κ±°λ νμ¤ν† λ¦¬ μλ™ κΈ°λ΅
- [x] TransactionType (CHARGE: 0, USE: 1) μ •ν™•ν κΈ°λ΅

#### Step2 μ¶”κ°€ κ²€μ¦
- [ ] μµλ€ μ”κ³  μ΄κ³Ό λ°©μ§€ (1,000,000 ν¬μΈνΈ)
- [ ] μµμ† κ±°λ κΈμ•΅ κ²€μ¦ (1 ν¬μΈνΈ)
- [ ] μµλ€ μΌν μ¶©μ „ μ ν• (100,000 ν¬μΈνΈ)
- [ ] μµλ€ μΌν μ‚¬μ© μ ν• (50,000 ν¬μΈνΈ)
- [ ] λ™μ‹ μ”μ²­ μ²λ¦¬ μ •μƒ λ™μ‘
- [ ] Race Condition λ°©μ§€

## π§ Step2 ν…μ¤νΈ μ‹λ‚λ¦¬μ¤

### λ‹¨μ„ ν…μ¤νΈ (Step1 μ™„λ£)
#### getUserPoint β…
- κΈ°μ΅΄ μ μ € μ΅°ν μ„±κ³µ
- μ‹ κ· μ μ € κΈ°λ³Έκ°’(0) λ°ν™

#### chargePoint β…  
- μ •μƒ μ¶©μ „ μ„±κ³µ
- 0μ› μ¶©μ „ μ—λ¬
- μμ μ¶©μ „ μ—λ¬
- νμ¤ν† λ¦¬ κΈ°λ΅ ν™•μΈ

#### usePoint β…
- μ •μƒ μ‚¬μ© μ„±κ³µ  
- μ”μ•΅ λ¶€μ΅± μ—λ¬
- 0μ› μ‚¬μ© μ—λ¬
- μμ μ‚¬μ© μ—λ¬
- νμ¤ν† λ¦¬ κΈ°λ΅ ν™•μΈ

#### getPointHistory β…
- λ‚΄μ—­ μ΅΄μ¬ν•λ” κ²½μ°
- λ‚΄μ—­ μ—†λ” κ²½μ°

### Step2 λ‹¨μ„ ν…μ¤νΈ μ¶”κ°€
#### ν¬μΈνΈ μ •μ±… κ²€μ¦
- [ ] μµλ€ μ”κ³  μ΄κ³Όμ‹ μ¶©μ „ μ—λ¬
- [ ] μµμ† κΈμ•΅ λ―Έλ§ κ±°λ μ—λ¬
- [ ] μµλ€ μΌν μ¶©μ „ μ΄κ³Ό μ—λ¬
- [ ] μµλ€ μΌν μ‚¬μ© μ΄κ³Ό μ—λ¬

### ν†µν•© ν…μ¤νΈ (Step2 μ‹ κ·)
#### κΈ°λ¥λ³„ ν†µν•© ν…μ¤νΈ
- [ ] ν¬μΈνΈ μ΅°ν ν†µν•© ν…μ¤νΈ (Controller β†’ Service β†’ Database)
- [ ] ν¬μΈνΈ μ¶©μ „ ν†µν•© ν…μ¤νΈ (μ •μ±… ν¬ν•¨)
- [ ] ν¬μΈνΈ μ‚¬μ© ν†µν•© ν…μ¤νΈ (μ •μ±… ν¬ν•¨)
- [ ] ν¬μΈνΈ λ‚΄μ—­ ν†µν•© ν…μ¤νΈ

#### μ •μ±… μμ™Έ μΌ€μ΄μ¤ ν†µν•© ν…μ¤νΈ
- [ ] μµλ€ μ”κ³  μ΄κ³Ό λ°©μ§€ κ²€μ¦
- [ ] κ±°λ ν•λ„ μ΄κ³Ό λ°©μ§€ κ²€μ¦
- [ ] μ”μ•΅ λ¶€μ΅± μƒμ„Έ κ²€μ¦

#### λ™μ‹μ„± ν†µν•© ν…μ¤νΈ
- [ ] λ™μΌ μ μ € λ™μ‹ μ¶©μ „ μ”μ²­ μ²λ¦¬
- [ ] λ™μΌ μ μ € λ™μ‹ μ‚¬μ© μ”μ²­ μ²λ¦¬
- [ ] νΌμ¬λ λ™μ‹ μ”μ²­ μ²λ¦¬ (μ¶©μ „ + μ‚¬μ©)
- [ ] Race Condition λ°©μ§€ κ²€μ¦
- [ ] λ°μ΄ν„° μΌκ΄€μ„± λ³΄μ¥ κ²€μ¦

## π¨ μ—λ¬ λ©”μ‹μ§€

### Step1 μ—λ¬ λ©”μ‹μ§€ (μ™„λ£)
- `"μ¶©μ „ κΈμ•΅μ€ 0λ³΄λ‹¤ μ»¤μ•Ό ν•©λ‹λ‹¤."`
- `"μ‚¬μ© κΈμ•΅μ€ 0λ³΄λ‹¤ μ»¤μ•Ό ν•©λ‹λ‹¤."`  
- `"ν¬μΈνΈκ°€ λ¶€μ΅±ν•©λ‹λ‹¤."`

### Step2 μ¶”κ°€ μ—λ¬ λ©”μ‹μ§€
- `"μµλ€ μ”κ³ λ¥Ό μ΄κ³Όν•  μ μ—†μµλ‹λ‹¤. (μµλ€: 1,000,000 ν¬μΈνΈ)"`
- `"μµμ† κ±°λ κΈμ•΅μ€ 1 ν¬μΈνΈμ…λ‹λ‹¤."`
- `"μΌν μµλ€ μ¶©μ „ ν•λ„λ¥Ό μ΄κ³Όν–μµλ‹λ‹¤. (μµλ€: 100,000 ν¬μΈνΈ)"`
- `"μΌν μµλ€ μ‚¬μ© ν•λ„λ¥Ό μ΄κ³Όν–μµλ‹λ‹¤. (μµλ€: 50,000 ν¬μΈνΈ)"`
- `"λ™μ‹ μ²λ¦¬ μ¤‘μ…λ‹λ‹¤. μ μ‹ ν›„ λ‹¤μ‹ μ‹λ„ν•΄μ£Όμ„Έμ”."`